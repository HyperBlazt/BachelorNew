using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;


namespace Roland_IO_Malware
{
    public class Scanner
    {
        /// <summary>
        /// The data folder.
        /// </summary>
        const string DataFolder = "Data\\";


        private CancellationTokenSource _mCancelTokenSource = null;

        private List<Task> m_TaskList = null;

        private Dictionary<string, int[]> cashingArray = new Dictionary<string, int[]>();
        private Dictionary<string, string> cashingCompleteString = new Dictionary<string, string>();
        private HashSet<string> _scannedCleanMd5Values = new HashSet<string>();
        private HashSet<string> _newMd5Values = new HashSet<string>();


        public void ClearMd5Values()
        {
            _newMd5Values = new HashSet<string>();
            cashingCompleteString = new Dictionary<string, string>();
            cashingArray = new Dictionary<string, int[]>();
        }



        public void LoadCashedValues()
        {
            if (File.Exists(Thread.GetDomain().BaseDirectory + "Cashing\\md5.data"))
            {
                _scannedCleanMd5Values = new HashSet<string>();
                var hashSet = DeserializeHashSet(Thread.GetDomain().BaseDirectory + "Cashing\\md5.data");
                if (hashSet != null)
                {
                    _scannedCleanMd5Values = hashSet;
                }
            }
        }

        public void SaveCashedValues()
        {
            Directory.CreateDirectory(Thread.GetDomain().BaseDirectory + "Cashing\\");
            string output = string.Join(";", _newMd5Values);
            if (File.Exists(Thread.GetDomain().BaseDirectory + "Cashing\\md5.data") && !output.Equals(string.Empty))
            {
                while (!IsFileReady(Thread.GetDomain().BaseDirectory + "Cashing\\md5.data"))
                {
                    TextWriter tsw = new StreamWriter(Thread.GetDomain().BaseDirectory + "Cashing\\md5.data", true);
                    tsw.Write(output);
                }
            }
            else
            {
                if (!output.Equals(string.Empty))
                {
                    var file = File.Create(Thread.GetDomain().BaseDirectory + "Cashing\\md5.data");
                    file.Close();

                    TextWriter tsw = new StreamWriter(Thread.GetDomain().BaseDirectory + "Cashing\\md5.data", true);
                    tsw.Write(output);
                    tsw.Close();
                }
            }
        }

        public static bool IsFileReady(String sFilename)
        {
            // If the file can be opened for exclusive access it means that the file
            // is no longer locked by another process.
            try
            {
                using (FileStream inputStream = File.Open(sFilename, FileMode.Open, FileAccess.Read, FileShare.None))
                {
                    if (inputStream.Length > 0)
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }

                }
            }
            catch (Exception)
            {
                return false;
            }
        }

        /// <summary>
        /// The scan file.
        /// </summary>
        /// <param name="substring">
        /// The substring.
        /// </param>
        /// <param name="splitOption"></param>
        /// <returns>
        /// The <see cref="bool"/>.
        /// </returns>
        public bool ScanFile(string substring, int splitOption)
        {
            if (_scannedCleanMd5Values.Contains(substring))
            {
                // Is already checked and clear, return false
                return false;
            }
            else
            {
                if (cashingArray.Count > 500 || cashingCompleteString.Count > 500)
                {
                    // Clear cash
                    cashingArray = new Dictionary<string, int[]>();
                    cashingCompleteString = new Dictionary<string, string>();
                }
                if (_scannedCleanMd5Values.Count > 10000)
                {
                    // Clear cash
                    _scannedCleanMd5Values = new HashSet<string>();
                }
                if (cashingArray.ContainsKey(substring.Substring(0, splitOption)) &&
                    cashingCompleteString.ContainsKey(substring.Substring(0, splitOption)))
                {
                    var cashedSuffixArray = cashingArray[substring.Substring(0, splitOption)];
                    var cashedCompleteString = cashingCompleteString[substring.Substring(0, splitOption)];
                    if (cashedSuffixArray != null || cashedCompleteString != string.Empty)
                    {
                        var result = !this.IndexOf(substring, cashedSuffixArray, cashedCompleteString).Equals(-1);
                        if (!result && !_newMd5Values.Contains(substring))
                        {
                            _newMd5Values.Add(substring);
                        }
                        return result;
                    }
                }
                else
                {
                    var databaseDirectory = Thread.GetDomain().BaseDirectory + DataFolder;
                    var suffixArray = this.DeserializeArray(databaseDirectory + substring.Substring(0, splitOption) + ".data");
                    var completeString =
                        this.DeserializeString(databaseDirectory + "string_" + substring.Substring(0, splitOption) + ".data");
                    if (suffixArray != null || completeString != string.Empty)
                    {
                        var result = !this.IndexOf(substring, suffixArray, completeString).Equals(-1);
                        if (!result && !_newMd5Values.Contains(substring))
                        {
                            _newMd5Values.Add(substring);
                        }
                        return result;
                    }
                }
            }
            return false;
        }

        /// <summary>
        /// The scan folder.
        /// </summary>
        /// <param name="directory">
        /// The directory.
        /// </param>
        /// <returns>
        /// The <see cref="List"/>.
        /// </returns>
        public List<string> ScanFolder(string directory)
        {
            _mCancelTokenSource = new CancellationTokenSource();
            // Get a reference to the cancellation token.
            CancellationToken readFileCancelToken = _mCancelTokenSource.Token;

            var fileList = new List<string>();
            var files = Directory.EnumerateFiles(@directory, "*.*", SearchOption.AllDirectories).ToList();
            foreach (var file in files)
            {
                Task.Factory.StartNew(() =>
                {
                    // If cancel has been chosen, throw an exception now before doing anything.
                    readFileCancelToken.ThrowIfCancellationRequested();
                    try
                    {
                        var md5 = this.GetMd5HashOfAFile(file);
                        if (!this.ScanFile(md5 + "$", 3))
                        {
                            var filenameWithoutExrtension = Path.GetFileNameWithoutExtension(file);

                            // Kill all programs that lock the current file
                            var lockedProcesses = FileUtil.WhoIsLocking(file).ToList();
                            foreach (var lockedProcess in lockedProcesses)
                            {
                                lockedProcess.Kill();
                            }

                            // Get all instances of Notepad running on the local computer.
                            Process[] localByName = Process.GetProcessesByName(filenameWithoutExrtension);
                            foreach (Process process in localByName)
                            {
                                process.Kill();
                            }
                            var databaseDirectory = Thread.GetDomain().BaseDirectory + @"Quarantine\";
                            if (File.Exists(databaseDirectory + filenameWithoutExrtension + ".qua"))
                            {
                                File.Delete(databaseDirectory + filenameWithoutExrtension + ".qua");
                            }
                            File.Move(file, databaseDirectory + filenameWithoutExrtension + ".qua");
                            fileList.Add(file);
                        }
                    }
                    catch (Exception)
                    {
                        if (File.Exists(file))
                        {
                            File.Delete(file);
                        }
                    }
                    finally
                    {
                        GC.Collect();
                    }
                }, readFileCancelToken);
            }

            return fileList;
        }

        ///// <summary>
        ///// The get malware database.
        ///// </summary>
        ///// <param name="fileName">
        ///// The file Name.
        ///// </param>
        //public void GetMalwareDatabase(string fileName)
        //{
        //    var databaseDirectory = Thread.GetDomain().BaseDirectory + "Data\\";
        //    this._suffixArray = this.DeserializeArray(databaseDirectory + fileName + ".data");
        //    this._completeString = this.DeserializeString(databaseDirectory + "string_" + fileName + ".data");
        //}

        /// <summary>
        /// The get md 5.
        /// </summary>
        /// <param name="file">
        /// The file.
        /// </param>
        /// <returns>
        /// The <see cref="string"/>.
        /// </returns>
        public string GetMd5(string file)
        {
            using (var md5 = MD5.Create())
            {
                using (var stream = File.OpenRead(file))
                {
                    var md5Byte = md5.ComputeHash(stream);
                    return BitConverter.ToString(md5Byte).Replace("-", string.Empty).ToLower();
                }
            }
        }

        public string GetMd5HashOfAFile(string file)
        {
            MD5CryptoServiceProvider md5 = new MD5CryptoServiceProvider();
            FileStream stream = new FileStream(file, FileMode.Open, FileAccess.Read, FileShare.Read, 8192);
            md5.ComputeHash(stream);
            stream.Close();

            byte[] hash = md5.Hash;
            return BitConverter.ToString(hash).Replace("-", "").ToLower();
        }

        /// <summary>
        /// Binary Search
        /// </summary>
        /// <param name="substr">
        /// The substr.
        /// </param>
        /// <param name="mSa">
        /// The m sa.
        /// </param>
        /// <param name="mStr">
        /// The m str.
        /// </param>
        /// <returns>
        /// The <see cref="int"/>.
        /// </returns>
        public int IndexOf(string substr, int[] mSa, string mStr)
        {
            int l = 0;
            int r = mSa.Length;
            int m = -1;

            if ((substr == null) || (substr.Length == 0))
            {
                return -1;
            }

            // Binary search for substring
            while (r > l)
            {
                m = (l + r) / 2;
                if (m < mSa.Length && mSa[m] < mStr.Length && mStr.Substring(mSa[m]).CompareTo(substr) < 0)
                {
                    l = m + 1;
                }
                else
                {
                    r = m;
                }
            }

            if ((l == r) && (l < mStr.Length) && l < mSa.Length && mSa[l] < mStr.Length && mStr.Substring(mSa[l]).StartsWith(substr))
            {
                return mSa[l];
            }
            else
            {
                return -1;
            }
        }

        /// <summary>
        /// The deserialize array.
        /// </summary>
        /// <param name="filePath">
        /// The file path.
        /// </param>
        /// <returns>
        /// The <see>
        ///         <cref>int[]</cref>
        ///     </see>
        ///     .
        /// </returns>
        public int[] DeserializeArray(string filePath)
        {
            if (File.Exists(filePath))
            {
                var text = File.ReadAllText(filePath);
                string[] words = text.Split(';');
                var done = words.Where(x => !string.IsNullOrEmpty(x)).ToArray();
                return Array.ConvertAll(done, int.Parse);
            }
            else
            {
                return null;
            }
        }

        public HashSet<string> DeserializeHashSet(string filePath)
        {
            if (File.Exists(filePath))
            {
                var text = File.ReadAllText(filePath);
                string[] words = text.Split(';');
                var done = words.Where(x => !string.IsNullOrEmpty(x)).ToArray();
                return new HashSet<string>(done);
            }
            else
            {
                return null;
            }
        }

        /// <summary>
        /// The deserialize string.
        /// </summary>
        /// <param name="filePath">
        /// The file path.
        /// </param>
        /// <returns>
        /// The <see cref="string"/>.
        /// </returns>
        public string DeserializeString(string filePath)
        {
            if (File.Exists(filePath))
            {
                var bytes = File.ReadAllBytes(filePath);
                return System.Text.Encoding.UTF8.GetString(bytes);
            }
            else
            {
                return string.Empty;
            }
        }

        public static string UnZip(string value)
        {
            //Transform string into byte[]
            byte[] byteArray = new byte[value.Length];
            int indexBA = 0;
            foreach (char item in value)
            {
                byteArray[indexBA++] = (byte)item;
            }

            //Prepare for decompress
            MemoryStream ms = new MemoryStream(byteArray);
            System.IO.Compression.GZipStream sr = new System.IO.Compression.GZipStream(ms,
                System.IO.Compression.CompressionMode.Decompress);

            //Reset variable to collect uncompressed result
            byteArray = new byte[byteArray.Length];

            //Decompress
            int rByte = sr.Read(byteArray, 0, byteArray.Length);

            //Transform byte[] unzip data to string
            System.Text.StringBuilder sB = new System.Text.StringBuilder(rByte);
            //Read the number of bytes GZipStream red and do not a for each bytes in
            //resultByteArray;
            for (int i = 0; i < rByte; i++)
            {
                sB.Append((char)byteArray[i]);
            }
            sr.Close();
            ms.Close();
            sr.Dispose();
            ms.Dispose();
            return sB.ToString();
        }
    }
}